{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Aug 2024 -> Aug 2025 percentage change by category (diverging lollipop).",
  "background": "transparent",

  "width": 900,
  "height": 400,

  "data": {
    "values": [
      {"Category":"Permanent arrivals","ChangePct":-5.7},
      {"Category":"Long-term resident returns","ChangePct":-0.6},
      {"Category":"Short-term resident returns","ChangePct":6.0},
      {"Category":"Long-term visitor arrivals","ChangePct":7.8},
      {"Category":"Short-term visitor arrivals","ChangePct":14.3},
      {"Category":"Long-term resident departures","ChangePct":-17.3},
      {"Category":"Short-term resident departures","ChangePct":5.2},
      {"Category":"Long-term visitor departures","ChangePct":5.6},
      {"Category":"Short-term visitor departures","ChangePct":13.7}
    ]
  },

  "transform": [
    {"calculate": "0", "as": "Zero"},
    {"calculate": "datum.ChangePct >= 0 ? 'Increase' : 'Decrease'", "as":"Direction"},
    {
      "joinaggregate": [
        {"op": "max", "field": "ChangePct", "as": "MaxChange"},
        {"op": "min", "field": "ChangePct", "as": "MinChange"}
      ]
    },
    {"calculate": "datum.ChangePct == datum.MaxChange", "as": "IsHighestPositive"},
    {"calculate": "datum.ChangePct == datum.MinChange", "as": "IsHighestNegative"},
    {"calculate": "'Highest positive change (' + format(datum.ChangePct,'+.1f') + '%)'", "as":"AnnoHighText"},
    {"calculate": "'Highest negative change (' + format(datum.ChangePct,'+.1f') + '%)'", "as":"AnnoLowText"}
  ],

  "layer": [
    {
      "mark": {"type":"rule", "strokeWidth":2, "opacity":0.6},
      "encoding": {
        "y": {"field":"Category","type":"nominal","sort":"-x","title":null},
        "x": {"field":"Zero","type":"quantitative", "axis": {"title": null}},
        "x2": {"field":"ChangePct"},
        "color": {"field":"Direction","type":"nominal","legend": null}
      }
    },
    {
      "mark": {"type":"point", "filled": true, "size": 100},
      "encoding": {
        "y": {"field":"Category","type":"nominal","sort":"-x"},
        "x": {"field":"ChangePct","type":"quantitative","title":"% change (2024 -> 2025)"},
        "color": {"field":"Direction","type":"nominal","legend":{"orient":"bottom"}},
        "tooltip": [
          {"field":"Category"},
          {"field":"ChangePct","type":"quantitative","title":"% change","format":"+.1f"}
        ]
      }
    },
    {
      "transform": [{"filter": "datum.IsHighestPositive"}],
      "mark": {"type":"text", "fontWeight":"bold", "baseline":"middle", "align":"left", "dx": 10},
      "encoding": {
        "y": {"field":"Category"},
        "x": {"field":"ChangePct"},
        "text": {"field":"AnnoHighText"},
        "color": {"value":"#0c8c34"}
      }
    },
    {
      "transform": [{"filter": "datum.IsHighestNegative"}],
      "mark": {"type":"text", "fontWeight":"bold", "baseline":"middle", "align":"right", "dx": -10},
      "encoding": {
        "y": {"field":"Category"},
        "x": {"field":"ChangePct"},
        "text": {"field":"AnnoLowText"},
        "color": {"value":"#d61c1c"}
      }
    }
  ],

  "config": {
    "axis": {"grid": true, "tickBand":"extent"},
    "axisX": { "title": null },
    "view": {"stroke": "#e8e2d8", "cornerRadius": 8}
  }
}
